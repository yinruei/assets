<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½è²¡å‹™ç›®æ¨™è¦åŠƒæ©Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22; /* é‡é»æ©˜è‰² */
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --secondary-text: #666;
            --radius: 12px;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--primary-color);
            color: white;
            padding: 25px;
            text-align: center;
        }

        header h1 { margin: 0; font-size: 1.6rem; }
        header p { margin: 8px 0 0; opacity: 0.8; font-size: 0.9rem; }

        /* Tabs for Mode Selection */
        .mode-tabs {
            display: flex;
            background: #eee;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s;
            border-radius: 8px;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .content {
            display: flex;
            flex-wrap: wrap;
        }

        .input-section {
            flex: 1;
            padding: 30px;
            min-width: 320px;
            border-right: 1px solid #eee;
            background: #fff;
        }

        .result-section {
            flex: 1.5;
            padding: 30px;
            background-color: #fafafa;
            min-width: 320px;
            display: flex;
            flex-direction: column;
        }

        .form-group { margin-bottom: 20px; position: relative; }
        
        /* Hidden class for dynamic inputs */
        .hidden { display: none; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--primary-color);
            font-size: 0.9rem;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input:focus { outline: none; border-color: var(--primary-color); }

        .btn-calculate {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.3s;
        }
        .btn-calculate:hover { opacity: 0.9; }

        /* Result Styles */
        .main-result {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .result-label { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 5px; }
        .result-value { color: var(--accent-color); font-size: 2rem; font-weight: 700; }
        .result-sub { font-size: 0.9rem; color: #888; margin-top: 5px; }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .content { flex-direction: column; }
            .input-section { border-right: none; border-bottom: 1px solid #eee; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>è²¡å‹™ç›®æ¨™è¦åŠƒæ©Ÿ</h1>
        <p>æ­£å‘é æ¸¬èˆ‡é€†å‘å›æ¨ï¼Œæ‰¾åˆ°æ‚¨çš„è²¡å¯Œè‡ªç”±æ–¹ç¨‹å¼</p>
    </header>

    <div class="mode-tabs">
        <button class="tab-btn active" onclick="setMode('normal')">ä¸€èˆ¬è¨ˆç®— (ç®—æ™‚é–“)</button>
        <button class="tab-btn" onclick="setMode('monthly')">å›æ¨ï¼šæ¯æœˆå­˜å¤šå°‘</button>
        <button class="tab-btn" onclick="setMode('rate')">å›æ¨ï¼šéœ€è¦å¹¾%å ±é…¬</button>
        <button class="tab-btn" onclick="setMode('startAge')">å›æ¨ï¼šå¹¾æ­²è¦é–‹å§‹</button>
    </div>

    <div class="content">
        <div class="input-section">
            
            <div class="form-group">
                <label>ğŸ’ è³‡ç”¢ç¸½ç›®æ¨™ (NT$)</label>
                <input type="number" id="target" value="10000000">
            </div>

            <div class="form-group">
                <label>ğŸŒ± åˆå§‹æŠ•è³‡é‡‘é¡ (NT$)</label>
                <input type="number" id="initial" value="100000">
            </div>

            <div class="form-group" id="grp-monthly">
                <label>ğŸ’° æ¯æœˆå®šæœŸå®šé¡ (NT$)</label>
                <input type="number" id="monthly" value="10000">
            </div>

            <div class="form-group" id="grp-rate">
                <label>ğŸ“ˆ å¹´åŒ–å ±é…¬ç‡ (%)</label>
                <input type="number" id="rate" value="6" step="0.1">
            </div>

            <div class="form-group" id="grp-currentAge">
                <label>ğŸ§‘ ç›®å‰å¹´é½¡ (æ­²)</label>
                <input type="number" id="currentAge" value="30">
            </div>

            <div class="form-group hidden" id="grp-targetAge">
                <label>ğŸ ç›®æ¨™é”æˆå¹´é½¡ / é€€ä¼‘å¹´é½¡ (æ­²)</label>
                <input type="number" id="targetAge" value="65">
            </div>

            <button class="btn-calculate" onclick="calculate()">é–‹å§‹è¨ˆç®—</button>
        </div>

        <div class="result-section">
            <div id="placeholder" style="text-align: center; color: #999; margin-top: 50px;">
                <p>è«‹é¸æ“‡æ¨¡å¼ä¸¦è¼¸å…¥æ•¸å€¼<br>é»æ“Šã€Œé–‹å§‹è¨ˆç®—ã€æŸ¥çœ‹çµæœ</p>
            </div>

            <div id="resultBox" class="hidden">
                <div class="main-result">
                    <div class="result-label" id="resLabel">é è¨ˆé”æˆæ™‚é–“</div>
                    <div class="result-value" id="resValue">--</div>
                    <div class="result-sub" id="resSub">--</div>
                </div>

                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMode = 'normal';
    let myChart = null;

    // ä»‹é¢åˆ‡æ›é‚è¼¯
    function setMode(mode) {
        currentMode = mode;
        
        // æ›´æ–° Tab æ¨£å¼
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // é¡¯ç¤º/éš±è—æ¬„ä½
        const show = (id) => document.getElementById(id).classList.remove('hidden');
        const hide = (id) => document.getElementById(id).classList.add('hidden');

        // é‡ç½®æ‰€æœ‰
        show('grp-monthly');
        show('grp-rate');
        show('grp-currentAge');
        hide('grp-targetAge'); // é è¨­éš±è—ç›®æ¨™å¹´é½¡

        if (mode === 'normal') {
            // ä¸€èˆ¬æ¨¡å¼ï¼šè¼¸å…¥ P, PMT, r, Age -> ç®— Time
        } else if (mode === 'monthly') {
            // ç®—æ¯æœˆï¼šè¼¸å…¥ P, r, Age, TargetAge -> ç®— PMT
            hide('grp-monthly');
            show('grp-targetAge');
        } else if (mode === 'rate') {
            // ç®—å ±é…¬ï¼šè¼¸å…¥ P, PMT, Age, TargetAge -> ç®— r
            hide('grp-rate');
            show('grp-targetAge');
        } else if (mode === 'startAge') {
            // ç®—é–‹å§‹ï¼šè¼¸å…¥ P, PMT, r, TargetAge -> ç®— StartAge
            hide('grp-currentAge'); // éš±è—ç›®å‰å¹´é½¡ï¼Œå› ç‚ºé€™æ˜¯æˆ‘å€‘è¦ç®—çš„
            show('grp-targetAge');
        }
        
        // æ¸…ç©ºçµæœ
        document.getElementById('resultBox').classList.add('hidden');
        document.getElementById('placeholder').classList.remove('hidden');
    }

    // æ ¼å¼åŒ–é‡‘éŒ¢
    const moneyFmt = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });

    function calculate() {
        const target = parseFloat(document.getElementById('target').value);
        const initial = parseFloat(document.getElementById('initial').value);
        let monthly = parseFloat(document.getElementById('monthly').value);
        let rate = parseFloat(document.getElementById('rate').value);
        let currentAge = parseInt(document.getElementById('currentAge').value);
        let targetAge = parseInt(document.getElementById('targetAge').value);

        if(isNaN(target) || isNaN(initial)) return alert("è«‹è¼¸å…¥æ­£ç¢ºæ•¸å€¼");

        let resultText = "";
        let resultSubText = "";
        let chartData = []; // {age, amount}

        // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---

        if (currentMode === 'normal') {
            // æ¨¡å¼ 1: ç®—å¤šä¹…é”æˆ
            let n = 0; // months
            let current = initial;
            let monthlyRate = rate / 100 / 12;
            
            while(current < target && n < 1200) { // Limit 100 years
                current = current * (1 + monthlyRate) + monthly;
                n++;
            }
            let years = (n / 12).toFixed(1);
            let finalAge = (currentAge + parseFloat(years)).toFixed(1);
            
            resultText = `${years} å¹´`;
            resultSubText = `å°‡åœ¨ ${finalAge} æ­²é”æˆç›®æ¨™`;
            document.getElementById('resLabel').innerText = "é è¨ˆæ‰€éœ€æ™‚é–“";
            
            generateChartData(currentAge, n/12, initial, monthly, rate);

        } else if (currentMode === 'monthly') {
            // æ¨¡å¼ 2: ç®—æ¯æœˆéœ€å­˜å¤šå°‘ (PMT)
            // PMT = (FV - PV*(1+r)^n) / [ ((1+r)^n - 1) / r ]
            let years = targetAge - currentAge;
            if (years <= 0) return alert("ç›®æ¨™å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡");
            
            let n = years * 12;
            let r = rate / 100 / 12;
            
            // è¤‡åˆ©å› å­
            let compoundFactor = Math.pow(1 + r, n);
            let futureValueOfInitial = initial * compoundFactor;
            let remainingTarget = target - futureValueOfInitial;
            
            if (remainingTarget <= 0) {
                monthly = 0;
                resultText = "ç„¡éœ€å†å­˜";
                resultSubText = "é åˆå§‹æœ¬é‡‘è¤‡åˆ©å³å¯é”æˆ";
            } else {
                // å¹´é‡‘å…¬å¼æ±‚ PMT
                if (r === 0) {
                    monthly = remainingTarget / n;
                } else {
                    monthly = remainingTarget * r / (compoundFactor - 1);
                }
                resultText = moneyFmt.format(monthly);
                resultSubText = `å¾ ${currentAge} æ­²å­˜åˆ° ${targetAge} æ­²`;
            }
            
            document.getElementById('resLabel').innerText = "æ¯æœˆéœ€å­˜é‡‘é¡";
            generateChartData(currentAge, years, initial, monthly, rate);

        } else if (currentMode === 'rate') {
            // æ¨¡å¼ 3: ç®—éœ€è¦å¤šå°‘å ±é…¬ç‡ (Binary Search)
            let years = targetAge - currentAge;
            if (years <= 0) return alert("ç›®æ¨™å¹´é½¡å¿…é ˆå¤§æ–¼ç›®å‰å¹´é½¡");
            
            let low = 0, high = 100; // %
            let foundRate = 0;
            
            // äºŒåˆ†æ³•é€¼è¿‘
            for(let i=0; i<100; i++) {
                let mid = (low + high) / 2;
                let r = mid / 100 / 12;
                let n = years * 12;
                
                let fv = initial * Math.pow(1+r, n) + monthly * ((Math.pow(1+r, n) - 1) / r);
                if (r === 0) fv = initial + monthly * n;

                if (Math.abs(fv - target) < 1000) {
                    foundRate = mid;
                    break;
                }
                if (fv > target) high = mid;
                else low = mid;
                foundRate = mid;
            }
            
            resultText = foundRate.toFixed(2) + " %";
            resultSubText = `è‹¥è¦åœ¨ ${years} å¹´å¾Œé”æˆç›®æ¨™`;
            document.getElementById('resLabel').innerText = "æ‰€éœ€å¹´åŒ–å ±é…¬ç‡";
            generateChartData(currentAge, years, initial, monthly, foundRate);

        } else if (currentMode === 'startAge') {
            // æ¨¡å¼ 4: ç®—æœ€æ™šå¹¾æ­²é–‹å§‹ (Back calculate time)
            // å…ˆç®—å‡ºéœ€è¦å¹¾å¹´ï¼Œå†ç”¨ç›®æ¨™å¹´é½¡æ‰£é™¤
            let n = 0;
            let current = initial;
            let monthlyRate = rate / 100 / 12;
            
            // æ¨¡æ“¬ç›´åˆ°é”æˆç›®æ¨™
            while(current < target && n < 1200) {
                current = current * (1 + monthlyRate) + monthly;
                n++;
            }
            
            let yearsNeeded = n / 12;
            let startAge = targetAge - yearsNeeded;
            
            if (startAge < 0) {
                resultText = "ä¸å¯èƒ½é”æˆ";
                resultSubText = "å³ä½¿å‡ºç”Ÿå°±é–‹å§‹å­˜ä¹Ÿä¾†ä¸åŠ";
            } else {
                resultText = startAge.toFixed(1) + " æ­²";
                resultSubText = `æœ€æ™šéœ€åœ¨æ­¤å¹´é½¡é–‹å§‹ï¼Œå­˜ ${yearsNeeded.toFixed(1)} å¹´`;
            }
            
            document.getElementById('resLabel').innerText = "æœ€æ™šé–‹å§‹å¹´é½¡";
            // åœ–è¡¨é¡¯ç¤ºå¾ startAge åˆ° targetAge
            generateChartData(startAge, yearsNeeded, initial, monthly, rate);
        }

        // é¡¯ç¤ºçµæœ
        document.getElementById('resValue').innerText = resultText;
        document.getElementById('resSub').innerText = resultSubText;
        document.getElementById('placeholder').classList.add('hidden');
        document.getElementById('resultBox').classList.remove('hidden');
    }

    // ç”¢ç”Ÿåœ–è¡¨æ•¸æ“š
    function generateChartData(startAge, durationYears, p, pmt, r_annual) {
        let labels = [];
        let data = [];
        let current = p;
        let r = r_annual / 100 / 12;
        let totalMonths = Math.ceil(durationYears * 12);
        
        // ç‚ºäº†åœ–è¡¨ç¾è§€ï¼Œå–ç´„ 20-30 å€‹é»
        let step = Math.max(1, Math.floor(totalMonths / 20));

        for(let m=0; m<=totalMonths; m++) {
            if (m % step === 0 || m === totalMonths) {
                let currentAge = parseFloat(startAge) + (m/12);
                labels.push(currentAge.toFixed(1));
                data.push(current);
            }
            current = current * (1 + r) + pmt;
        }

        renderChart(labels, data);
    }

    function renderChart(labels, data) {
        const ctx = document.getElementById('growthChart').getContext('2d');
        if (myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'è³‡ç”¢ç´¯ç©è¶¨å‹¢',
                    data: data,
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230, 126, 34, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => moneyFmt.format(ctx.parsed.y)
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'å¹´é½¡' } },
                    y: { 
                        ticks: { callback: (v) => v/10000 + 'è¬' } 
                    }
                }
            }
        });
    }

    // åˆå§‹åŒ–
    setMode('normal');
</script>

</body>
</html>